<div class="container-fluid">
  <form [formGroup]="form"
    (ngSubmit)="corpusFormSubject$.next($event)">
    <div class="row">
      <div class="col-md-12">
        <div class="d-flex">
          <div class="flex-grow-1">
            <tag-input [formControlName]="'chips'"
              [inputText]="inputText" [editable]="true"
              [identifyBy]="'value'" [displayBy]="'display'"
              [allowDupes]="true" [theme]="'bootstrap'"
              [addOnBlur]="true" [clearOnBlur]="true"
              [addOnPaste]="true" [onlyFromAutocomplete]="false"
              [dragZone]="'zone1'" [onAdding]="transform"
              [pasteSplitPattern]="splitpattern6"
              [separatorKeyCodes]="[32]" [ngClass]="{
                'is-invalid': submitted && chips.invalid,
                missing_parameters: checkIfKeyDocumentApplied()
              }" [errorMessages]="errorMessages"
              [validators]="validators"
              [placeholder]="placeholder"
              [secondaryPlaceholder]="secondaryPlaceholder"
              (onSelect)="onSelect($event)"
              (onAdd)="onAdd($event)"
              (onFocus)="toggleQueryFocusStyle(true)"
              (onBlur)="toggleQueryFocusStyle(false)">
              <ng-template item-template let-item="item"
                let-index="index">

                <div
                  [ngClass]="{'general': true, 'vertex': item.termType === 'String', 'document': item.termType === 'Document'}">

                  <span class="pr-1" [ngbPopover]="popContent"
                    [popoverTitle]="popTitle"
                    [autoClose]="'outside'"
                    triggers="mouseenter"
                    container="body"
                    [disablePopover]="item.termType !== 'Document'"
                    popoverClass="testClass">
                    <ng-template #popContent
                      style="max-width: 800px;">
                      <!-- {{item?.document?.title}} -->
                      <b>{{item.value}}</b>
                    </ng-template>
                    <ng-template #popTitle>
                      <!-- {{item?.document?.id}} -->
                      {{item.display}}
                    </ng-template>
                    <fa-icon *ngIf="item.termType === 'Document'"
                      [icon]="faFile" animation="spin"
                      style="font-size: 0.8em">
                    </fa-icon>
                    {{ item.display }}
                  </span>
                  <span (click)="removeItem(item, index)">
                    <fa-icon [icon]="faTimes" animation="spin"
                      style="font-size: 0.8em">
                    </fa-icon>
                  </span>
                </div>


              </ng-template>
              <tag-input-dropdown [showDropdownIfEmpty]="false"
                [autocompleteObservable]="requestAutocompleteItemsFake">
              </tag-input-dropdown>
            </tag-input>
          </div>
          <div [ngClass]="{
              inbar: true,
              'is-infocus': toggleQueryFocusStyleBlue(),
              'is-infocus-red': toggleQueryFocusStyleRed()
            }">
            <button type="button"
              class="btn btn-outline-secondary searchbar-info pt-3"
              (click)="cleanAllChips()">
              <fa-icon [icon]="faTimes" animation="spin"
                style="font-size: 0.8em"
                [ngbTooltip]="clean_query">
              </fa-icon>
            </button>
          </div>
          <!-- EXCEL
           <button type="button"
              [disabled]="totalElements === 0 || totalElements === null"
              class="btn btn-outline-secondary searchbar-info pt-3"
              (click)="downloadExcel()">
              <fa-icon [icon]="faFileExcel"
                class="excel"
                [ngbTooltip]="excelContent">
              </fa-icon>
            </button>
          </div> -->
          <!-- ELLIPSIS -->
          <div
            [ngClass]="{ 
            inbar: true, 'is-infocus': toggleQueryFocusStyleBlue(), 'is-infocus-red': toggleQueryFocusStyleRed() }">
            <div ngbDropdown #drop0 placement="bottom-right"
              autoClose="outside">
              <button type="button" id="dropdownSearch"
                class="btn btn-outline-secondary searchbar-info pt-3"
                ngbDropdownToggle>
                <!-- (openChange)="toggleDropdown(drop0);" -->
                <fa-icon [icon]="faEllipsisV">
                </fa-icon>
              </button>
              <div ngbDropdownMenu class="drop-menu"
                aria-labelledby="dropdownSearch">

                <div ngbDropdown #drop1 placement="left-top"
                  autoClose="outside"
                  *ngIf="this.currentUser && this.currentUser.username">
                  <!-- (openChange)="toggleDropdown(drop1);" -->
                  <button type="button" id="dropdownConfig"
                    (click)="checkDropDown(drop1)"
                    class="dropdown-menuitem drop-menuitem-link"
                    ngbDropdownToggle>My
                    queries</button>

                  <div ngbDropdownMenu id="queries"
                    aria-labelledby="dropdownConfig">

                    <app-query-store-tree [files]="rows"
                      (nodeSelected)="executeQuery($event)"
                      ngbDropdownItem>
                    </app-query-store-tree>

                  </div>
                </div>

                <button type="button" (click)="copyQuery()"
                  [ngbTooltip]="copyContent"
                  class="drop-menuitem-link" ngbDropdownItem>
                  <fa-icon [icon]="faCopy"
                    style="background-color: #fff;color: #495057;">
                  </fa-icon>
                  &nbsp;Copy query
                </button>
                <!-- ----------------- DO NOT REMOVE ----------------- -->

                <!-- BUTTON CALLING DOCUMENT EXCEL EXPORT FUCNTIONALITY -->
                <!-- <button type="button" (click)="downloadExcel()"
                    ngbDropdownItem
                    [ngbTooltip]="excelContent">Export excel&nbsp;
                    <fa-icon [icon]="faFileExcel" class="excel">
                    </fa-icon>
                  </button> -->

                <!-- ----------------- DO NOT REMOVE ----------------- -->
              </div>
            </div>
          </div>
          <div [ngClass]="{
              inbar: true,
              'is-infocus': toggleQueryFocusStyleBlue(),
              'is-infocus-red': toggleQueryFocusStyleRed()
            }">
            <!-- ADVANCED SEARCH -->
            <button type="button"
              class="btn btn-outline-secondary searchbar-info pt-3"
              type="button" (click)="openXl()">
              <fa-icon [icon]="faFilter"
                [ngbTooltip]="advancedContent"> </fa-icon>
              <span *ngIf="filterCounter > 0">&#183;{{
                filterCounter }}</span>
            </button>
            <!-- FILE UPLOAD -->
            <button type="button"
              class="btn btn-outline-secondary searchbar-info pt-3"
              type="button" (click)="openXl2()">
              <fa-icon [icon]="faFileUpload"
                [ngbTooltip]="fileUpload"> </fa-icon>
            </button>
          </div>


          <div [ngClass]="{
              inbar: true,
              'is-infocus': toggleQueryFocusStyleBlue(),
              'is-infocus-red': toggleQueryFocusStyleRed()
            }">
            <!-- SEARCH -->
            <button
              [ngClass]="{ missing_parameters: checkIfKeyDocumentApplied() }"
              type="submit"
              class="btn btn-outline-secondary yellow"
              ngbTooltip="Click to apply your search">
              <!-- #tt="ngbTooltip" -->
              <fa-icon [icon]="faSearch"> </fa-icon>
            </button>
          </div>

        </div>
      </div>

      <div class="col-md-2 d-flex align-items-center">
        <ng-template #copyContent>Copy the query</ng-template>


        <ng-template #loadQuery>Load query</ng-template>

        <ng-template #saveQuery>Save query</ng-template>


        <ng-template #clean_query>Clean the query</ng-template>
        <ng-template #excelContent>Download 100 top results in
          excel</ng-template>
        <ng-template #advancedContent><em>Metadata filters</em>
        </ng-template>
        <ng-template #fileUpload><em>Load document or text</em>
        </ng-template>
        <ng-template #infoContent><em>Use</em><strong> AND
          </strong> connector to include
          both terms in the search.</ng-template>
        <ng-template #clickToApply><em>Click</em> to apply your
          search</ng-template>
      </div>
    </div>
    <div class="row"
      *ngIf="submitted && chips.invalid && chips.errors.forbiddenName">
      <div class="col-md-12">
        <div class="search-custom-select alert alert-danger">
          <div *ngIf="chips.errors.forbiddenName">
            {{ chips.errors.forbiddenName.value }}
          </div>
        </div>
      </div>
    </div>
  </form>
  <div class="row" *ngIf="vertexes && vertexes.length > 0">
    <div class="col-md-12">
      <!-- TODO delete suggestions -->
      <!-- TODO appending mode -->
      <!-- TODO reset button -->
      <!-- TODO Make the content of suggestions (grey chips) hint box to show text: "Drag and drop me!" instead of the term string itself -->
      <tag-input [(ngModel)]="vertexes" [hideForm]="true"
        [editable]="false" [removable]="false"
        [identifyBy]="'display'" [displayBy]="'display'"
        [allowDupes]="true" [addOnBlur]="true"
        [clearOnBlur]="true" [addOnPaste]="true"
        [dragZone]="'zone1'" placement="top" [autoClose]="true"
        ngbTooltip="Drag and drop me!" container="body">
        <tag-input-dropdown [showDropdownIfEmpty]="false"
          [autocompleteObservable]="requestAutocompleteItemsFake">
        </tag-input-dropdown>
      </tag-input>
    </div>
  </div>
</div>