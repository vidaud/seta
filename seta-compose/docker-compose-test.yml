version: "3.8"
name: seta-test
services:
  seta-mongo-test:
    container_name: mongo-test
    extends:
      file: common.yml
      service: mongo
    restart: "no"
    ports:
      - "27018:27017"
    networks:
      - seta-network-test      

  seta-opensearch-test:
    container_name: opensearch-test
    restart: "no"   
    build:
      context: ../seta-opensearch
      args:
        - HTTP_PROXY=${HTTP_PROXY}
        - HTTPS_PROXY=${HTTPS_PROXY}
    mem_limit: "4g"
    environment:
      - NO_PROXY=${NO_PROXY}
      - no_proxy=${NO_PROXY}
      - bootstrap.memory_lock=true
      - plugins.security.disabled=true
      - discovery.type=single-node
      - logger.level=WARN
    expose:
      - "9200"
      - "9300"
    ports:
      - "0.0.0.0:9200:9200"
      - "0.0.0.0:9300:9300"
    volumes:
      - opensearch-data-test:/usr/share/opensearch/data
    networks:
      - seta-network-test

  seta-api-test:
    container_name: api-test
    extends:
      file: common.yml
      service: api
    restart: "no"
    build:
      dockerfile: seta-api/Dockerfile-test
    networks:
      - seta-network-test
    depends_on:
      - "seta-mongo-test"
      - "seta-opensearch-test"

  seta-nginx-test:
    container_name: nginx-test
    extends:
      file: common.yml
      service: nginx
    restart: "no"
    build: 
       args:
        - PROJECT_CONF=project_test
    ports:
      - "8080:8080"
    depends_on:
      - "seta-auth-test"
      - "seta-api-test"
      - "seta-ui-test"
    networks:
      - seta-network-test

  seta-ui-test:
    container_name: ui-test
    extends:
      file: common.yml
      service: ui
    restart: "no"
    build: 
      dockerfile: seta-ui/dockerfiles/Dockerfile-ui-test
    depends_on:
      - "seta-api-test"
    networks:
      - seta-network-test

  seta-data-test:
    container_name: data-test
    extends:
      file: common.yml
      service: data
    depends_on:
      - "seta-opensearch-test"
    volumes:
      - seta-models3-test:/home/seta/models
    networks:
      - seta-network-test

  seta-auth-test:
    container_name: auth-test
    extends:
      file: common.yml
      service: auth
    restart: "no"
    build:
      dockerfile: seta-ui/dockerfiles/Dockerfile-auth-test
    networks:
      - seta-network-test
    depends_on:
      - "seta-mongo-test"

networks:
  seta-network-test:
    name: seta-network-test
    driver: bridge

volumes:
  opensearch-data-test:
  seta-models3-test: